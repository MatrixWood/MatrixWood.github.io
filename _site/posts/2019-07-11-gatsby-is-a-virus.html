<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Noel Welsh: Gatsby is a Virus; Here's the Cure</title>
        <link rel="stylesheet" href="../css/bootstrap.min.css" />
        <link rel="stylesheet" href="../css/noelwelsh.css" />
        <link rel="stylesheet" href="../css/tango.css" />
        <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Merriweather" rel="stylesheet">
    </head>
    <body>
        <header class="page-header">
            <nav class="nav justify-content-center">
                <strong><a class="nav-link active" href="../">Home</a></strong>
                <a class="nav-link" href="../writing.html">Writing</a>
                <a class="nav-link" href="../projects.html">Projects</a>
                <a class="nav-link" href="../about.html">About</a>
            </nav>
        </header>
        <div class="container">
            <div class="row justify-content-center">
                <div class="col col-9">
                    <main role="main">
                        <article>
    <section class="header">
        <h1>Gatsby is a Virus; Here's the Cure</h1>
        
            <p><small>July 11, 2019</small></p>
        
    </section>
    <section>
        <p><a href="https://www.gatsbyjs.org/">Gatsby</a> is a Javascript framework for building static sites. It has the pernicious effect of infecting the browser cache, and won’t go away until you manually clear the cache or deploy a file that kills it. Here I describe the problem and the solution.</p>
<!--more-->
<p>The herpes virus is a common virus with one very unfortunate ability: your body can never truly gets rid of it. Instead, when the initial infection dies down it goes to live in your ganglia, waiting to reemerge at the least convenient time. Gatsby is similar, though instead of infecting human ganglia it infects browser caches. There it will live indefinitely, causing browsers to display old pages even if you no longer use Gatsby. Luckily, unlike herpes, there is a way to kill Gatsby for good so that an up-to-date site will be displayed.</p>
<p>I created some simple static sites using Gatsby. I wanted to experiment with some different technology, which was fun for a bit, but after a while I decided Gatsby wasn’t for me. I shifted my sites to another static site generator and here is where the fun began. I noticed whenever I visited my site the old Gatsby pages were displayed, no matter how often I refreshed. I assumed it was due to caching that would soon expire, so I manually cleared the cache and moved on. The sites aren’t heavily trafficed so I didn’t notice any issue. However, over sixty days later I opened up one of the sites in a web browser I don’t use very often—and the old Gatsby pages displayed! Gatsby had infected the browser cache and <em>after two months</em> it still had not expired! One of the static sites is likely to get more traffic in the near future so I knew I had to resolve this.</p>
<p>I couldn’t find the issue documented on Gatsby’s site, but a bit of searching found some discussion of web workers. I don’t fully understand how Gatsby uses web workers but I worked out the cure nonetheless. To kill Gatsby you need to deploy a file called <code>sw.js</code> in the root directory which should contain</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="va">self</span>.<span class="at">addEventListener</span>(<span class="st">'install'</span><span class="op">,</span> <span class="kw">function</span>(e) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-2" title="2">    <span class="va">self</span>.<span class="at">skipWaiting</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="va">self</span>.<span class="at">addEventListener</span>(<span class="st">'activate'</span><span class="op">,</span> <span class="kw">function</span>(e) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="va">self</span>.<span class="va">registration</span>.<span class="at">unregister</span>()</a>
<a class="sourceLine" id="cb1-7" title="7">        .<span class="at">then</span>(<span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-8" title="8">            <span class="cf">return</span> <span class="va">self</span>.<span class="va">clients</span>.<span class="at">matchAll</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb1-9" title="9">        <span class="op">}</span>)</a>
<a class="sourceLine" id="cb1-10" title="10">        .<span class="at">then</span>(<span class="kw">function</span>(clients) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-11" title="11">            <span class="va">clients</span>.<span class="at">forEach</span>(client <span class="kw">=&gt;</span> <span class="va">client</span>.<span class="at">navigate</span>(<span class="va">client</span>.<span class="at">url</span>))</a>
<a class="sourceLine" id="cb1-12" title="12">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>With this in place Gatsby will be killed and your new site will be displayed.</p>
<p>I opened <a href="https://github.com/gatsbyjs/gatsby/issues/15623#issuecomment-510405199">an issue</a> about this. I was disappointed with the response. The team don’t seem to feel they have any responsibility to even document this issue. Hence I’m documenting the problem and solution here in the hope others will benefit from it.</p>
    </section>
</article>

                    </main>
                </div>
            </div>
        </div>

        <footer class="text-center">
            <small>
                Site generated by
                <a href="http://jaspervdj.be/hakyll">Hakyll</a>
            </small>
        </footer>
    </body>
</html>
